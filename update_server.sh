#!/bin/bash
# ============================================
# –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GolubBozor –Ω–∞ PythonAnywhere
# ============================================

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–∞..."

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd ~/golub_bozor || { echo "‚ùå –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å GitHub..."
git pull origin main

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source venv/bin/activate

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install -r requirements.txt -q

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üóÉÔ∏è –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
python manage.py migrate

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ç–µ–π (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
echo "üìö –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–µ–π —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏–∏..."
python manage.py shell << EOF
from core.models import HealthGuide
if HealthGuide.objects.count() == 0:
    print("–°–æ–∑–¥–∞—é —Å—Ç–∞—Ç—å–∏...")
    exit(1)
else:
    print(f"–°—Ç–∞—Ç–µ–π —É–∂–µ {HealthGuide.objects.count()}, –ø—Ä–æ–ø—É—Å–∫–∞—é")
EOF

if [ $? -eq 1 ]; then
    python populate_health.py
fi

# –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
echo "üñºÔ∏è –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
python manage.py collectstatic --no-input

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É Web: https://www.pythonanywhere.com/user/magaj/webapps/"
echo "   2. –ù–∞–∂–º–∏—Ç–µ –∑–µ–ª—ë–Ω—É—é –∫–Ω–æ–ø–∫—É 'Reload magaj.pythonanywhere.com'"
echo "   3. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç: https://magaj.pythonanywhere.com"
echo ""
